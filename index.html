<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Meeting Room Booking - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #f1f8e9 100%);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #00bcd4 0%, #4caf50 100%);
        }
        
        .room-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .room-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 188, 212, 0.15);
        }
        
        .room-available {
            border-color: #4caf50;
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
        }
        
        .room-booked {
            border-color: #f44336;
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
        }
        
        .calendar-day {
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
            background-color: #b2ebf2;
        }
        
        .calendar-day.selected {
            background: linear-gradient(135deg, #00bcd4 0%, #4caf50 100%);
            color: white;
        }
        
        .time-slot {
            transition: all 0.2s ease;
        }
        
        .time-slot:hover {
            background-color: #b2ebf2;
        }
        
        .time-slot.selected {
            background: linear-gradient(135deg, #00bcd4 0%, #4caf50 100%);
            color: white;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold text-center">üè¢ Smart Meeting Room Booking</h1>
            <p class="text-center text-lg mt-2 opacity-90">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</p>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4">
            <div class="flex justify-center space-x-1 py-3">
                <button onclick="showPage('booking')" class="nav-btn px-6 py-2 rounded-lg font-medium transition-all duration-200 bg-cyan-500 text-white">
                    üìÖ ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
                </button>
                <button onclick="showPage('myBookings')" class="nav-btn px-6 py-2 rounded-lg font-medium transition-all duration-200 text-cyan-600 hover:bg-cyan-50">
                    üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                </button>
                <button onclick="showPage('allBookings')" class="nav-btn px-6 py-2 rounded-lg font-medium transition-all duration-200 text-cyan-600 hover:bg-cyan-50">
                    üìä ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
                </button>
                <button onclick="showPage('statistics')" class="nav-btn px-6 py-2 rounded-lg font-medium transition-all duration-200 text-cyan-600 hover:bg-cyan-50">
                    üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Booking Page -->
        <div id="bookingPage" class="page">
            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Calendar Section -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                        </h3>
                        <div class="calendar-container">
                            <div class="flex justify-between items-center mb-4">
                                <button onclick="changeMonth(-1)" class="p-2 rounded-lg bg-cyan-100 text-cyan-600 hover:bg-cyan-200">
                                    ‚Üê
                                </button>
                                <h4 id="currentMonth" class="font-semibold text-lg"></h4>
                                <button onclick="changeMonth(1)" class="p-2 rounded-lg bg-cyan-100 text-cyan-600 hover:bg-cyan-200">
                                    ‚Üí
                                </button>
                            </div>
                            <div class="grid grid-cols-7 gap-1 mb-2">
                                <div class="text-center text-sm font-medium text-gray-600 py-2">‡∏≠‡∏≤</div>
                                <div class="text-center text-sm font-medium text-gray-600 py-2">‡∏à</div>
                                <div class="text-center text-sm font-medium text-gray-600 py-2">‡∏≠</div>
                                <div class="text-center text-sm font-medium text-gray-600 py-2">‡∏û</div>
                                <div class="text-center text-sm font-medium text-gray-600 py-2">‡∏û‡∏§</div>
                                <div class="text-center text-sm font-medium text-gray-600 py-2">‡∏®</div>
                                <div class="text-center text-sm font-medium text-gray-600 py-2">‡∏™</div>
                            </div>
                            <div id="calendarDays" class="grid grid-cols-7 gap-1"></div>
                        </div>
                        
                        <!-- Time Selection -->
                        <div class="mt-6">
                            <h4 class="font-semibold text-gray-800 mb-3">‚è∞ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                                    <select id="startTime" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                                        <!-- Time options will be populated by JavaScript -->
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                                    <select id="endTime" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                                        <!-- Time options will be populated by JavaScript -->
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Room Selection -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                            üè¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
                        </h3>
                        <div id="roomList" class="grid md:grid-cols-2 gap-4">
                            <!-- Rooms will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Bookings Page -->
        <div id="myBookingsPage" class="page hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                    üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                </h3>
                
                <!-- Filters -->
                <div class="grid md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á</label>
                        <select id="roomFilter" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500">
                            <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="dateFilter" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500">
                    </div>
                    <div class="flex items-end">
                        <button onclick="applyFilters()" class="w-full bg-cyan-500 text-white px-4 py-2 rounded-lg hover:bg-cyan-600 transition-colors">
                            üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                    </div>
                </div>
                
                <div id="myBookingsList" class="space-y-4">
                    <!-- My bookings will be populated here -->
                </div>
            </div>
        </div>

        <!-- All Bookings Calendar Page -->
        <div id="allBookingsPage" class="page hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                    üìä ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </h3>
                
                <!-- Room Filter -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π</label>
                    <select id="calendarRoomFilter" onchange="updateCalendarView()" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500">
                        <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
                    </select>
                </div>
                
                <!-- Calendar View -->
                <div class="calendar-view">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="changeCalendarMonth(-1)" class="px-4 py-2 bg-cyan-100 text-cyan-600 rounded-lg hover:bg-cyan-200">
                            ‚Üê ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô
                        </button>
                        <h4 id="calendarCurrentMonth" class="text-xl font-semibold"></h4>
                        <button onclick="changeCalendarMonth(1)" class="px-4 py-2 bg-cyan-100 text-cyan-600 rounded-lg hover:bg-cyan-200">
                            ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-7 gap-2">
                        <div class="text-center font-semibold text-gray-700 py-3 bg-gray-100 rounded">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</div>
                        <div class="text-center font-semibold text-gray-700 py-3 bg-gray-100 rounded">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</div>
                        <div class="text-center font-semibold text-gray-700 py-3 bg-gray-100 rounded">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</div>
                        <div class="text-center font-semibold text-gray-700 py-3 bg-gray-100 rounded">‡∏û‡∏∏‡∏ò</div>
                        <div class="text-center font-semibold text-gray-700 py-3 bg-gray-100 rounded">‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</div>
                        <div class="text-center font-semibold text-gray-700 py-3 bg-gray-100 rounded">‡∏®‡∏∏‡∏Å‡∏£‡πå</div>
                        <div class="text-center font-semibold text-gray-700 py-3 bg-gray-100 rounded">‡πÄ‡∏™‡∏≤‡∏£‡πå</div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-2 mt-2">
                        <!-- Calendar days will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Page -->
        <div id="statisticsPage" class="page hidden">
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </h4>
                    <div class="text-3xl font-bold text-cyan-600" id="totalBookings">0</div>
                    <p class="text-gray-600 mt-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        üèÜ ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                    </h4>
                    <div class="text-lg font-semibold text-green-600" id="mostUsedRoom">-</div>
                    <p class="text-gray-600 mt-2" id="mostUsedRoomCount">0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        ‚è∞ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                    </h4>
                    <div class="text-lg font-semibold text-blue-600" id="peakTime">-</div>
                    <p class="text-gray-600 mt-2" id="peakTimeCount">0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                </div>
                
                <div class="md:col-span-2 lg:col-span-3 bg-white rounded-xl shadow-lg p-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á</h4>
                    <div id="roomStats" class="space-y-3">
                        <!-- Room statistics will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 m-4 max-w-md w-full">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">üìù ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
            
            <form id="bookingForm" onsubmit="submitBooking(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</label>
                        <input type="text" id="selectedRoom" readonly class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="text" id="selectedDate" readonly class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏ß‡∏•‡∏≤</label>
                        <input type="text" id="selectedTime" readonly class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô *</label>
                        <input type="text" id="department" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô *</label>
                        <textarea id="purpose" required rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"></textarea>
                    </div>
                </div>
                
                <div class="flex space-x-3 mt-6">
                    <button type="button" onclick="closeBookingModal()" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="submit" class="flex-1 px-4 py-3 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 transition-colors">
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cancel Booking Modal -->
    <div id="cancelModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 m-4 max-w-md w-full">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
            <p class="text-gray-600 mb-4">‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</p>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</label>
                <input type="password" id="cancelCode" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                <p id="cancelError" class="text-red-500 text-sm mt-1 hidden">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
            </div>
            
            <div class="flex space-x-3">
                <button onclick="closeCancelModal()" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    ‡∏õ‡∏¥‡∏î
                </button>
                <button onclick="confirmCancel()" class="flex-1 px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <script>
/* ==================== CONFIG ==================== */
/* ‚òÖ‚òÖ ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ URL ‡∏à‡∏≤‡∏Å Deploy Web App ‡∏Ç‡∏≠‡∏á Apps Script ‚òÖ‚òÖ */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyC19_Cd2dhCztJKxDCCPzreMuwQwlHs0i2anQlBotZF0qOXSc8COeU-WmxF2pHyTyq/exec";

/* ============== Apps Script bridge (fetch) ============== */
async function gsList({ dates = [], roomId = "" } = {}) {
  const p = new URLSearchParams({ action: "list" });
  if (dates.length === 1) p.append("date", dates[0]);
  if (dates.length > 1) p.append("dates", dates.join(","));
  if (roomId) p.append("roomId", roomId);
  const r = await fetch(`${WEB_APP_URL}?${p.toString()}`);
  const j = await r.json(); return j.bookings || [];
}
async function gsCreate(booking) {
  const r = await fetch(WEB_APP_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ action: "create", booking })
  });
  const j = await r.json(); if (!j.ok) throw new Error(j.error || "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  return j.booking;
}
async function gsCancel(id, code = "1234") {
  const r = await fetch(WEB_APP_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ action: "cancel", id, code })
  });
  const j = await r.json(); if (!j.ok) throw new Error(j.error || "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  return j;
}

/* ==================== App State ==================== */
let currentDate = new Date();
let selectedDates = [];
let selectedRoomForBooking = null;
let bookings = [];               // cache ‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
let currentBookingToCancel = null;
let calendarCurrentDate = new Date();
const USER_ID = (()=>{ const k="smart-meeting-user"; let v=localStorage.getItem(k);
  if(!v){ v="U-"+Math.random().toString(36).slice(2,8); localStorage.setItem(k,v) } return v; })();

// Room data (‡∏Ñ‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏∏‡∏ì)
const rooms = [
  { id: 'usr',       name: '‡∏´‡πâ‡∏≠‡∏áUSR(1-101)',                 capacity: 70,  location: '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ 1 ‡∏ä‡∏±‡πâ‡∏ô 1' },
  { id: 'seminar',   name: '‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏±‡∏°‡∏°‡∏ô‡∏≤',                     capacity: 80,  location: '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ 3 ‡∏ä‡∏±‡πâ‡∏ô 1' },
  { id: 'pukya1',    name: '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏û‡∏∏‡∏Ñ‡∏¢‡∏≤‡∏†‡∏£‡∏ì‡πå 1',        capacity: 360, location: '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ 3 ‡∏ä‡∏±‡πâ‡∏ô 1' },
  { id: 'pukya2',    name: '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏û‡∏∏‡∏Ñ‡∏¢‡∏≤‡∏†‡∏£‡∏ì‡πå 2 (3-206)', capacity: 120, location: '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ 3 ‡∏ä‡∏±‡πâ‡∏ô 2' },
  { id: 'executive', name: '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ 3-202',     capacity: 40,  location: '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ 3 ‡∏ä‡∏±‡πâ‡∏ô 2' }
];

/* ==================== Helpers ==================== */
function iso(d){ const z=d.getTimezoneOffset(); const l=new Date(d.getTime()-z*60000); return l.toISOString().slice(0,10); }
function timeOverlap(s1, e1, s2, e2){ return s1 < e2 && e1 > s2; }
function tonight(){ const t=new Date(); t.setHours(0,0,0,0); return t; }

/* ==================== INIT ==================== */
async function init() {
  generateTimeOptions();
  // default ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
  selectedDates = [new Date()];
  generateCalendar();
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
  document.getElementById('startTime').value='09:00';
  document.getElementById('endTime').value='10:00';
  // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï
  await refreshSelectedDatesFromSheet();
  updateRoomList();
  await updateMyBookings();
  await updateStatistics();
  populateRoomFilters();
  await updateCalendarView();
}

/* ==================== Time Options ==================== */
function generateTimeOptions() {
  const startSelect = document.getElementById('startTime');
  const endSelect = document.getElementById('endTime');
  startSelect.innerHTML = ''; endSelect.innerHTML = '';
  for (let hour = 9; hour <= 20; hour++) {
    for (let minute of [0, 30]) {
      if (hour === 20 && minute === 30) continue;
      const t = `${hour.toString().padStart(2,'0')}:${minute.toString().padStart(2,'0')}`;
      startSelect.innerHTML += `<option value="${t}">${t}</option>`;
      endSelect.innerHTML   += `<option value="${t}">${t}</option>`;
    }
  }
}

/* ==================== Calendar (date picker on booking page) ==================== */
function generateCalendar() {
  const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
  document.getElementById('currentMonth').textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear() + 543}`;

  const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
  const startDate = new Date(firstDay); startDate.setDate(startDate.getDate() - firstDay.getDay());

  const calendarDays = document.getElementById('calendarDays'); calendarDays.innerHTML='';
  const t0 = tonight();

  for (let i = 0; i < 42; i++) {
    const date = new Date(startDate); date.setDate(startDate.getDate() + i);
    const cell = document.createElement('div');
    cell.className = 'calendar-day text-center p-2 rounded-lg cursor-pointer';
    cell.textContent = date.getDate();

    if (date.getMonth() !== currentDate.getMonth()) {
      cell.className += ' text-gray-400';
    } else if (date < t0) {
      cell.className += ' text-gray-400 cursor-not-allowed';
    } else {
      cell.onclick = () => toggleDateSelection(date);
      if (selectedDates.some(d => d.toDateString() === date.toDateString())) cell.className += ' selected';
      if (date.toDateString() === (new Date()).toDateString()) cell.className += ' bg-yellow-100 border border-yellow-300';
    }
    calendarDays.appendChild(cell);
  }
}
function changeMonth(direction){ currentDate.setMonth(currentDate.getMonth()+direction); generateCalendar(); }
async function toggleDateSelection(date){
  const t0 = tonight(); if (date < t0) return;
  const idx = selectedDates.findIndex(d => d.toDateString() === date.toDateString());
  if (idx>-1) selectedDates.splice(idx,1); else selectedDates.push(new Date(date));
  generateCalendar();
  await refreshSelectedDatesFromSheet();
  updateRoomList();
}

/* ==================== Fetchers ==================== */
async function refreshSelectedDatesFromSheet(){
  bookings = [];
  if (!selectedDates.length) return;
  const dates = selectedDates.map(d => iso(d)).sort();
  const chunk=10;
  for (let i=0;i<dates.length;i+=chunk){
    const part = dates.slice(i,i+chunk);
    const list = await gsList({ dates: part });
    bookings = bookings.concat(list||[]);
  }
}
async function fetchMonthBookings(y, m, roomId=''){
  const last = new Date(y, m+1, 0).getDate();
  const dates = Array.from({length:last}, (_,i)=> iso(new Date(y, m, i+1)));
  let all=[]; const chunk=10;
  for (let i=0;i<dates.length;i+=chunk){
    const part=dates.slice(i,i+chunk);
    const list=await gsList({ dates: part, roomId });
    all = all.concat(list||[]);
  }
  return all;
}
async function fetchRecentBookings(days=180){
  const start = new Date(); start.setDate(start.getDate()-days);
  const end = new Date();   end.setDate(end.getDate()+days);
  const dates=[]; for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) dates.push(iso(d));
  let out=[]; const chunk=10;
  for (let i=0;i<dates.length;i+=chunk){
    const part=dates.slice(i,i+chunk);
    const list=await gsList({ dates: part });
    out = out.concat(list||[]);
  }
  return out;
}

/* ==================== Room list & status ==================== */
function updateRoomList(){
  const roomList = document.getElementById('roomList');
  const startTime = document.getElementById('startTime').value;
  const endTime   = document.getElementById('endTime').value;
  roomList.innerHTML = '';

  rooms.forEach(room => {
    let isAvailable = true;
    if (selectedDates.length && startTime && endTime){
      for (const d of selectedDates){
        const ds = iso(d);
        const conflict = bookings.some(b =>
          String(b.roomId) === String(room.id) &&
          String(b.date)   === ds &&
          b.status !== 'cancelled' &&
          timeOverlap(startTime, endTime, b.start || b.startTime, b.end || b.endTime)
        );
        if (conflict){ isAvailable=false; break; }
      }
    }

    const div = document.createElement('div');
    div.className = 'room-card p-4 rounded-lg cursor-pointer ' + (isAvailable ? 'room-available' : 'room-booked');
    div.innerHTML = `
      <div class="flex justify-between items-start mb-3">
        <h4 class="font-semibold text-lg text-gray-800">${room.name}</h4>
        <span class="text-sm ${isAvailable ? 'text-green-600' : 'text-red-600'}">
          ${isAvailable ? '‚úÖ ‡∏ß‡πà‡∏≤‡∏á' : '‚ùå ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß'}
        </span>
      </div>
      <p class="text-gray-600 text-sm mb-2">üìç ${room.location}</p>
      <p class="text-gray-600 text-sm mb-3">üë• ‡∏à‡∏∏‡πÑ‡∏î‡πâ ${room.capacity} ‡∏Ñ‡∏ô</p>
      ${isAvailable ? '<p class="text-cyan-600 text-sm font-medium">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á</p>' : ''}
    `;
    if (isAvailable && selectedDates.length && startTime && endTime){
      div.onclick = () => openBookingModal(room);
    }
    roomList.appendChild(div);
  });
}

/* ==================== Booking Modal & Submit ==================== */
function openBookingModal(room){
  selectedRoomForBooking = room;
  document.getElementById('selectedRoom').value = room.name;
  document.getElementById('selectedDate').value = selectedDates.map(d=> d.toLocaleDateString('th-TH')).join(', ');
  document.getElementById('selectedTime').value = `${document.getElementById('startTime').value} - ${document.getElementById('endTime').value}`;
  const m = document.getElementById('bookingModal'); m.classList.remove('hidden'); m.classList.add('flex');
}
function closeBookingModal(){
  const m = document.getElementById('bookingModal'); m.classList.add('hidden'); m.classList.remove('flex');
  document.getElementById('bookingForm').reset();
}
async function submitBooking(event){
  event.preventDefault();
  const department = document.getElementById('department').value.trim();
  const purpose    = document.getElementById('purpose').value.trim();
  const startTime  = document.getElementById('startTime').value;
  const endTime    = document.getElementById('endTime').value;
  if (!department || !purpose){ alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }

  try{
    for (const d of selectedDates){
      const payload = {
        userId: USER_ID,
        roomId: selectedRoomForBooking.id,
        roomName: selectedRoomForBooking.name,
        date: iso(d),
        start: startTime,
        end: endTime,
        dept: department,
        purpose: purpose
      };
      const saved = await gsCreate(payload);
      bookings.push(saved); // update cache
    }
    closeBookingModal();
    await refreshSelectedDatesFromSheet();
    updateRoomList(); await updateMyBookings(); await updateStatistics(); await updateCalendarView();
    alert('‚úÖ ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
  }catch(e){
    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ: ' + e.message);
  }
}

/* ==================== Navigation (pages) ==================== */
function showPage(pageId){
  document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
  document.getElementById(pageId+'Page').classList.remove('hidden');
  document.querySelectorAll('.nav-btn').forEach(btn=>{
    btn.className='nav-btn px-6 py-2 rounded-lg font-medium transition-all duration-200 text-cyan-600 hover:bg-cyan-50';
  });
  if (window.event && window.event.target){
    window.event.target.className='nav-btn px-6 py-2 rounded-lg font-medium transition-all duration-200 bg-cyan-500 text-white';
  }
  if (pageId==='myBookings') updateMyBookings();
  if (pageId==='statistics') updateStatistics();
  if (pageId==='allBookings') updateCalendarView();
}

/* ==================== My Bookings ==================== */
async function updateMyBookings(){
  let all = await fetchRecentBookings(180);
  all = all.filter(b=> b.status !== 'cancelled');
  let view = all.filter(b=> String(b.userId||'') === String(USER_ID));

  const roomFilter = document.getElementById('roomFilter')?.value || '';
  const dateFilter = document.getElementById('dateFilter')?.value || '';
  if (roomFilter) view = view.filter(b=> String(b.roomId)===String(roomFilter));
  if (dateFilter) view = view.filter(b=> String(b.date)===String(dateFilter));

  const box = document.getElementById('myBookingsList');
  if (!view.length){ box.innerHTML='<p class="text-gray-500 text-center py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>'; return; }

  view.sort((a,b)=> (a.date<b.date?-1:a.date>b.date?1:0) || ((a.start||a.startTime)<(b.start||b.startTime)?-1:1));

  box.innerHTML = view.map(b=>`
    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
      <div class="flex justify-between items-start">
        <div class="flex-1">
          <h4 class="font-semibold text-lg text-gray-800">${b.roomName || b.roomId}</h4>
          <p class="text-gray-600 mt-1">üìÖ ${new Date(b.date).toLocaleDateString('th-TH')}</p>
          <p class="text-gray-600">‚è∞ ${(b.start||b.startTime)} - ${(b.end||b.endTime)}</p>
          <p class="text-gray-600">üè¢ ${b.dept || b.department || '-'}</p>
          <p class="text-gray-600 mt-2">${b.purpose||'-'}</p>
        </div>
        <div class="flex flex-col space-y-2">
          ${b.status!=='cancelled'
            ? `<button onclick="openCancelModal('${b.id}')" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm hover:bg-red-200 transition-colors">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>`
            : '<span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>'}
        </div>
      </div>
    </div>
  `).join('');
}
function applyFilters(){ updateMyBookings(); }

/* ==================== Cancel booking ==================== */
function openCancelModal(bookingId){
  currentBookingToCancel = bookingId;
  const m = document.getElementById('cancelModal'); m.classList.remove('hidden'); m.classList.add('flex');
}
function closeCancelModal(){
  const m = document.getElementById('cancelModal'); m.classList.add('hidden'); m.classList.remove('flex');
  document.getElementById('cancelCode').value=''; document.getElementById('cancelError').classList.add('hidden');
  currentBookingToCancel = null;
}
async function confirmCancel(){
  const code = document.getElementById('cancelCode').value;
  const err = document.getElementById('cancelError');
  if (code!=='1234'){ err.classList.remove('hidden'); return; }
  err.classList.add('hidden');
  try{
    await gsCancel(currentBookingToCancel, code);
    bookings = bookings.map(b=> b.id==currentBookingToCancel ? {...b, status:'cancelled'} : b);
    await updateMyBookings(); updateRoomList(); await updateStatistics(); await updateCalendarView();
    alert('‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
  }catch(e){ alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+ e.message); }
  closeCancelModal();
}

/* ==================== Statistics ==================== */
async function updateStatistics(){
  const y = calendarCurrentDate.getFullYear(), m = calendarCurrentDate.getMonth();
  const monthData = await fetchMonthBookings(y, m, '');
  const confirmed = monthData.filter(b=> b.status!=='cancelled');

  document.getElementById('totalBookings').textContent = confirmed.length;

  const roomUsage = {};
  confirmed.forEach(b => { const key = b.roomId; roomUsage[key] = (roomUsage[key]||0)+1; });
  let mostRoom = '-', max = 0;
  Object.entries(roomUsage).forEach(([rid,c])=>{ if(c>max){max=c; mostRoom = (rooms.find(r=>r.id===rid)?.name || rid);} });
  document.getElementById('mostUsedRoom').textContent = mostRoom;
  document.getElementById('mostUsedRoomCount').textContent = `${max} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;

  const timeUsage = {};
  confirmed.forEach(b => { const t=(b.start||b.startTime||'').slice(0,2)+':00'; timeUsage[t]=(timeUsage[t]||0)+1; });
  let peak='-', tmax=0; Object.entries(timeUsage).forEach(([t,c])=>{ if(c>tmax){tmax=c; peak=t;} });
  document.getElementById('peakTime').textContent = peak;
  document.getElementById('peakTimeCount').textContent = `${tmax} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;

  const roomStats = document.getElementById('roomStats');
  roomStats.innerHTML = rooms.map(room => {
    const usage = roomUsage[room.id] || 0;
    const pct = confirmed.length ? (usage/confirmed.length*100).toFixed(1) : 0;
    return `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
      <span class="font-medium">${room.name}</span>
      <div class="flex items-center space-x-3">
        <span class="text-sm text-gray-600">${usage} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (${pct}%)</span>
        <div class="w-20 bg-gray-200 rounded-full h-2"><div class="bg-cyan-500 h-2 rounded-full" style="width:${pct}%"></div></div>
      </div>
    </div>`;
  }).join('');
}

/* ==================== Monthly Calendar (All bookings) ==================== */
async function updateCalendarView(){
  const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
  document.getElementById('calendarCurrentMonth').textContent = `${monthNames[calendarCurrentDate.getMonth()]} ${calendarCurrentDate.getFullYear() + 543}`;

  const firstDay = new Date(calendarCurrentDate.getFullYear(), calendarCurrentDate.getMonth(), 1);
  const startDate = new Date(firstDay); startDate.setDate(startDate.getDate() - firstDay.getDay());
  const calendarGrid = document.getElementById('calendarGrid'); calendarGrid.innerHTML='';

  const roomFilter = document.getElementById('calendarRoomFilter').value || '';
  const y = calendarCurrentDate.getFullYear(), m = calendarCurrentDate.getMonth();
  const monthData = await fetchMonthBookings(y, m, roomFilter);
  for (let i=0;i<42;i++){
    const date = new Date(startDate); date.setDate(startDate.getDate()+i);
    const dateStr = iso(date);
    const inMonth = date.getMonth()===calendarCurrentDate.getMonth();
    const list = monthData.filter(b=> String(b.date)===dateStr && b.status!=='cancelled' && (!roomFilter || String(b.roomId)===String(roomFilter)));
    const dayEl = document.createElement('div');
    dayEl.className = 'min-h-32 p-2 border border-gray-200 rounded-lg' + (inMonth?'':' bg-gray-50');
    dayEl.innerHTML = `
      <div class="font-semibold text-sm mb-1 ${inMonth?'':'text-gray-400'}">${date.getDate()}</div>
      ${list.map(b=>`
        <div class="text-xs bg-cyan-100 text-cyan-800 p-1 rounded mb-1" title="‡∏´‡πâ‡∏≠‡∏á: ${b.roomName||b.roomId}
‡πÄ‡∏ß‡∏•‡∏≤: ${(b.start||b.startTime)}-${(b.end||b.endTime)}
‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: ${b.purpose||''}">
          <div class="font-medium truncate">${(b.start||b.startTime)}-${(b.end||b.endTime)}</div>
          <div class="truncate">${b.roomName||b.roomId}</div>
          <div class="truncate text-cyan-600">${b.purpose||''}</div>
        </div>
      `).join('')}
    `;
    calendarGrid.appendChild(dayEl);
  }
}
function changeCalendarMonth(direction){ calendarCurrentDate.setMonth(calendarCurrentDate.getMonth()+direction); updateCalendarView(); }

/* ==================== Filters & Events ==================== */
function populateRoomFilters(){
  const roomFilter = document.getElementById('roomFilter');
  const calendarRoomFilter = document.getElementById('calendarRoomFilter');
  rooms.forEach(r => {
    const opt = `<option value="${r.id}">${r.name}</option>`;
    roomFilter.innerHTML += opt; calendarRoomFilter.innerHTML += opt;
  });
}
document.getElementById('startTime').addEventListener('change', ()=>{ updateRoomList(); });
document.getElementById('endTime').addEventListener('change', ()=>{ updateRoomList(); });

/* ==================== Boot ==================== */
init();
</script>
{function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98438ffbb12d4b64',t:'MTc1ODczMDMzNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
